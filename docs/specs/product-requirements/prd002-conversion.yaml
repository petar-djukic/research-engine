# Copyright Mesh Intelligence Inc., 2026. All rights reserved.

id: prd002-conversion
title: PDF to Markdown Conversion
problem: |
  Academic papers are distributed as PDFs, a format optimized for visual
  rendering rather than machine processing. Downstream pipeline stages
  (extraction, knowledge base, generation) need structured Markdown text.
  We delegate the actual PDF parsing to external tools (GROBID, pdftotext,
  markitdown) and focus on orchestration: invoking the backend, storing
  output, tracking conversion status, and processing batches.

goals:
  - G1: Convert a PDF file into Markdown using an external conversion backend
  - G2: Support batch conversion of multiple papers with progress reporting

requirements:
  R1:
    title: Output Format and Storage
    items:
      - R1.1: Convert must write the output Markdown file to papers/markdown/ with the same base filename as the source PDF (e.g. "2301.07041.md")
      - R1.2: Convert must create the papers/markdown/ directory if it does not exist
      - R1.3: The output Markdown must begin with a YAML frontmatter block containing the paper identifier, source PDF path, and conversion timestamp
      - R1.4: Convert must update the Paper metadata record in papers/metadata/ to indicate conversion status (converted, partial, or failed)

  R2:
    title: Conversion Backend
    items:
      - R2.1: Convert must support three conversion backends invoked as subprocesses â€” GROBID, pdftotext, and markitdown (container-based)
      - R2.2: Convert must accept a configuration option to select the conversion backend
      - R2.3: Convert must return a descriptive error when the configured backend is not installed or not found on PATH
      - R2.4: The markitdown backend must run inside a container using the markitdown:latest image, piping the PDF via stdin and capturing Markdown on stdout
      - R2.5: Convert must provide a runtime auto-detection function that checks for docker first and falls back to podman if docker is unavailable
      - R2.6: The runtime auto-detection function must verify the binary exists on PATH (e.g. "docker" or "podman") and return the name of the available runtime
      - R2.7: Before invoking the markitdown container, Convert must verify the markitdown:latest image exists locally by running the equivalent of "docker image inspect markitdown:latest" or "podman image exists markitdown:latest" using the detected runtime
      - R2.8: Convert must return a descriptive error when no container runtime (docker or podman) is available
      - R2.9: Convert must return a descriptive error when the markitdown:latest image is not found locally

  R3:
    title: Batch Processing
    items:
      - R3.1: Convert must accept a list of Paper records or PDF paths and process each one
      - R3.2: Convert must skip papers whose Markdown output already exists on disk (idempotent operation)
      - R3.3: Convert must print status (converting, skipped, failed) for each paper to stdout
      - R3.4: Convert must return a summary at the end of a batch (count of converted, skipped, and failed papers)
      - R3.5: Convert must return a non-zero exit code if any paper in the batch failed

non_goals:
  - We do not build our own PDF parser; structure preservation, column merging, heading detection, OCR, and content handling are delegated to the conversion backend
  - We do not extract images or figures from PDFs
  - We do not support non-English papers in this phase
  - We do not handle supplementary materials or appendices differently from the main text
  - We do not require both docker and podman to be installed; one container runtime is sufficient for the markitdown backend

acceptance_criteria:
  - Convert produces a Markdown file with YAML frontmatter for a given PDF
  - Convert skips a paper whose Markdown output already exists
  - Convert returns a descriptive error when the backend is not available
  - Batch conversion continues after individual failures and reports a summary
